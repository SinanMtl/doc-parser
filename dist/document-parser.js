import T from"fs";import w from"path";class O{constructor(){this.supportedExtensions=[".js",".jsx",".ts",".tsx",".vue",".html"],this.extractedTexts=[]}isNonTextualContent(t){const{text:e,isAttribute:n=!1,isJS:s=!1}=t;return[/^&[a-zA-Z]+;$/,/^https?:\/\//,/^\/[\/\w-]+$/,/^[0-9\s\-\+\(\)]+$/,/^[A-Z_]{5,}$/,/^\s*$/,/^[\w-]+\.(js|css|png|jpg|gif|svg)$/i,/^[a-z]+([A-Z][a-z]*)*$/,/^[a-z]+-[a-z-]+$/,/^[a-z]+_[a-z_]+$/i,/api\..*\.com/i,/^(ok|yes|no|true|false)$/i,/^\w{1,2}$/,/^\\[nrtbfv\\'"0]$/,/^[\\\/\*\{\}\[\]()<>;,.:!?'"=+\-~^&|%$#@]+$/,/^\/\*$/,/^\*\/$/,/^\/\/$/,/^[{}[\]()<>]$/,/^[;,.:!?'"]+$/,/^[+\-*/%=&|^~<>]+$/,/^\$\{/,/^.*\}$/,/^.*content\s*\+=/,/^;\s*$/,/^['"]\([^'"]*$/,/^\][^'"]*['"]*$/,/^[^'"]*\)['"]*$/,/^:\s*\n\s*case\s*$/,/^,\s*\n\s*$/,...s?[/^[A-Z][A-Z0-9_]{4,}$/]:[],/^[a-z]+[A-Z][a-z]*[A-Z][a-z]*$/,/^[a-z]+-[a-z]+-[a-z-]+$/,/^(src|alt|id|css|js|php|html|xml|json)$/i,...n?[]:[/^[a-zA-Z]*-[a-zA-Z-]*$/],/^[A-Z]+_[A-Z0-9_]+$/,/^[a-z]+([A-Z][a-z]*)+$/,/^\/.*\/[gimsuyx]*$/].some(t=>t.test(e.trim()))}getFileExtension(t){const e=t.split(".");return e.length>1?e[e.length-1].toLowerCase():""}parseFile(t){const e=w.extname(t).toLowerCase(),n=w.basename(t);try{const s=T.readFileSync(t,"utf8");return this.parseContent(s,e,{filePath:t,fileName:n})}catch(e){return console.error(`Error reading file ${t}:`,e.message),null}}parseContent(t,e,n){return this.supportedExtensions.includes(e)?(t=this.escapeRegExp(t),{...n||{},extension:e,extractedText:this.extractTextByType(t,e),timestamp:(new Date).toISOString()}):(console.warn(`Unsupported file type: ${e}`),null)}extractTextByType(t,e){const n={strings:[],htmlText:[],attributes:[],templateText:[],classNames:[],ids:[]};switch(e){case".js":case".ts":return this.parseJavaScriptTypeFiles(t);case".jsx":case".tsx":return this.parseJSXFile(t);case".vue":return this.parseVueFile(t);case".html":return this.parseHtmlFile(t);default:return n}}parseJavaScriptTypeFiles(t){const e={strings:[]},n=this.extractMeaningfulStringsWithPosition(t,"javascript");return e.strings.push(...n),e}parseJSXFile(t){const e={strings:[],classNames:[],ids:[]},n=[...t.matchAll(/return\s*\(\s*([\s\S]*?)\s*\);/g)],s=[];n.forEach(n=>{const i=n[1],r=n.index+n[0].indexOf(n[1]),o=r+i.length;s.push({start:r,end:o});const a=this.parseHtmlContent(i,!0,r,t,"html");e.strings.push(...a.htmlText),e.strings.push(...a.naturalLanguageAttributes)});const i=this.extractJavaScriptStringsExcludingJSX(t,s,"javascript");return e.strings.push(...i),e}extractJavaScriptStringsExcludingJSX(t,e,n="javascript"){const s=[];[/"(?:[^"\\]|\\.)*"/g,/'(?:[^'\\]|\\.)*'/g,/`(?:[^`\\]|\\.)*`/g].forEach(n=>{let i;for(;null!==(i=n.exec(t));){const t=i.index,n=i.index+i[0].length;e.some(e=>t>=e.start&&n<=e.end)||s.push(i)}});const i=[],r=[/require\s*\(/,/import\s+.*\s+from\s+/,/export\s+.*\s+from\s+/];return s.forEach(e=>{const s=e[0],o=e.index,a=Math.max(0,o-100),l=t.substring(a,o+s.length+50);let u=r.some(t=>t.test(l));if(!u){const e=s.slice(1,-1),n=this.isInsideFunctionCall(t,o),i=t.substring(Math.max(0,o-200),o),r=/console\.(log|error|warn|info|debug|trace)\s*\(\s*['"`]*$/.test(i),a=[/^[\[\](){}.*+?^$\\|]+$/,/^\[.*\]$/,/^\(.*\)$/,/^\\[a-z]$/,/\[\^[^[\]]*\]/,/\$\{|\}\$/].some(t=>t.test(e)),l=/\$t\(|\\.t\(|i18n\\.t\(/.test(e),c=/\bt\s*\(/.test(e),g=e.length<=2,h=/^[^a-zA-Z0-9\s\u00C0-\u017F\u0100-\u024F\u1E00-\u1EFF\u0400-\u04FF\u0370-\u03FF\u0590-\u05FF\u0600-\u06FF\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF\uAC00-\uD7AF]+$/.test(e);u=a||l||c||g||h||n||r}if(!u){const e=s.slice(1,-1);if(e.trim().length>2&&!this.isNonTextualContent({text:e})){const r=this.getPositionInfo(t,o,o+s.length),a=o+1,l=o+s.length-1,u=this.getPositionInfo(t,a,l);i.push({text:e.replace(/\n/,"").trim(),type:"string",context:n,lineNumber:u.lineNumber,startPosition:u.columnStart,endPosition:u.columnEnd,columnStart:u.columnStart,columnEnd:u.columnEnd,absoluteStart:u.absoluteStart,absoluteEnd:u.absoluteEnd,originalStartPosition:r.columnStart,originalEndPosition:r.columnEnd,originalAbsoluteStart:r.absoluteStart,originalAbsoluteEnd:r.absoluteEnd,originalMatch:s})}}}),i}escapeRegExp(t){let e,n=t.replace(/^https?:\/\//gm,t=>" ".repeat(t.length));n=n.replace(/<[^>]*>/gm,t=>" ".repeat(t.length));const s=/(\/\*([\s\S]*?)\*\/|[^\\]\/\/.+)/g;for(;null!==(e=s.exec(n));){const t=e[0];for(const e of t.split("\n"))n=n.replace(e,"".padStart(e.length," "))}const i=/(\/(.*)\/+([gimuy]*))/gm;let r,o=-1,a=-1;for(;null!==(r=i.exec(n));){-1===o&&(o=r.index);const t=r[0].replace(/^(!|=)\s{1,}?/,"").trim();try{const e=t.match(/^\/(.*)\/([gimuy]*)$/);if(e){const s=e[1],i=e[2];new RegExp(s,i),n=n.replace(t,`"${"".padStart(t.length-2,"*")}"`),a=r.index+t.length}}catch{continue}}const l=n.slice(o,a),u=t.slice(o,a);return t.replace(u,l)}extractMeaningfulStringsWithPosition(t,e="javascript"){const n=[],s=[],i=/"(?:[^"\\]|\\.)*"/g;let r;for(;null!==(r=i.exec(t));)s.push(r);const o=/'(?:[^'\\]|\\.)*'/g;for(;null!==(r=o.exec(t));)s.push(r);const a=/`(?:[^`\\]|\\.|[\r\n])*`/g;for(;null!==(r=a.exec(t));){const e=t.substring(Math.max(0,r.index-100),r.index),n=t.substring(r.index+r[0].length,r.index+r[0].length+20);/\[[^\]]*$/.test(e)&&/^[^\]]*\]/.test(n)||s.push(r)}const l=[/require\s*\(/,/import\s+.*\s+from\s+/,/export\s+.*\s+from\s+/];return s.forEach(s=>{const i=s[0],r=s.index,o=Math.max(0,r-100),a=t.substring(o,r+i.length+50);let u=l.some(t=>t.test(a));if(!u){const e=i.slice(1,-1),n=this.isInsideFunctionCall(t,r),s=t.substring(Math.max(0,r-200),r),o=/console\.(log|error|warn|info|debug|trace)\s*\(\s*['"`]*$/.test(s),a=[/^[\[\](){}.*+?^$\\|]+$/,/^\[.*\]$/,/^\(.*\)$/,/^\\[a-z]$/,/\[\^[^[\]]*\]/,/\$\{|\}\$/].some(t=>t.test(e)),l=/\$t\(|\\.t\(|i18n\\.t\(/.test(e),c=/\bt\s*\(/.test(e),g=e.length<=2,h=/^[^a-zA-Z0-9\s\u00C0-\u017F\u0100-\u024F\u1E00-\u1EFF\u0400-\u04FF\u0370-\u03FF\u0590-\u05FF\u0600-\u06FF\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF\uAC00-\uD7AF]+$/.test(e);u=a||l||c||g||h||n||o}if(!u){const s=i.slice(1,-1);if(s.trim().length>2&&!this.isNonTextualContent({text:s})){const o=this.getPositionInfo(t,r,r+i.length),a=r+1,l=r+i.length-1,u=this.getPositionInfo(t,a,l);n.push({text:s.replace(/\n/,"").trim(),type:"string",context:e,lineNumber:u.lineNumber,startPosition:u.columnStart,endPosition:u.columnEnd,columnStart:u.columnStart,columnEnd:u.columnEnd,absoluteStart:u.absoluteStart,absoluteEnd:u.absoluteEnd,originalStartPosition:o.columnStart,originalEndPosition:o.columnEnd,originalAbsoluteStart:o.absoluteStart,originalAbsoluteEnd:o.absoluteEnd,originalMatch:i})}}}),n}isHtmlAttributeValue(t,e){const n=Math.max(0,e-200),s=Math.min(t.length,e+200),i=t.substring(n,s),r=e-n,o=i.substring(0,r),a=i.substring(r+1),l=o.lastIndexOf("=");if(-1===l)return!1;const u=o.substring(0,l).trim().match(/([\w-]+)\s*$/);if(!u)return!1;const c=u[1].toLowerCase(),g=t[e];return-1!==a.indexOf(g)&&/<[^>]*>/.test(i)&&(/^(class|classname|id|style|src|href|type|name|role|aria-\w+|data-\w+|key|ref|onclick|onchange|value|checked|disabled|readonly|placeholder|title|alt)$/i.test(c)||/^on[A-Z]/.test(c)||/^(v-|:)/.test(c)||c.includes("-")||c.toLowerCase().startsWith("data"))}isInsideFunctionCall(t,e){const n=Math.max(0,e-300),s=t.substring(n,e),i=[];for(let t=s.length-1;t>=0;t--)if("("===s[t]){const e=s.substring(0,t).trim();/(\w+(\.\w+)*|\]\s*)$/.test(e)&&i.push(n+t)}for(const n of i){let s=1,i=null;for(let e=n+1;e<t.length&&s>0;e++)if("("===t[e])s++;else if(")"===t[e]&&(s--,0===s)){i=e;break}if(i&&e>n&&e<i)return!0}return!1}extractMeaningfulStrings(t){return this.extractMeaningfulStringsWithPosition(t,"html").map(t=>t.text)}parseVueFile(t){const e={htmlText:[],naturalLanguageAttributes:[],strings:[]},n=t.match(/<template[^>]*>([\s\S]*?)<\/template>/i);if(n){const s=n[1],i=t.indexOf(n[0])+n[0].indexOf(s),r=this.parseHtmlContent(s,!1,0,void 0,"vue");r.htmlText.forEach(t=>{t.absoluteStart+=i,t.absoluteEnd+=i,e.htmlText.push(t)}),r.naturalLanguageAttributes.forEach(t=>{t.absoluteStart+=i,t.absoluteEnd+=i,e.naturalLanguageAttributes.push(t)})}const s=t.match(/<script[^>]*>([\s\S]*?)<\/script>/i);if(s){const n=s[1],i=t.indexOf(s[0])+s[0].indexOf(n);this.parseJavaScriptTypeFiles(n).strings.forEach(n=>{const s=this.getPositionInfo(t,n.absoluteStart+i,n.absoluteEnd+i);n.lineNumber=s.lineNumber,n.startPosition=s.startPosition,n.endPosition=s.endPosition,n.absoluteStart+=i,n.absoluteEnd+=i,e.strings.push(n)})}return e}parseHtmlFile(t){const e={htmlText:[],naturalLanguageAttributes:[],strings:[]},n=this.parseHtmlContent(t,!1,0,void 0,"html");e.htmlText.push(...n.htmlText),e.naturalLanguageAttributes.push(...n.naturalLanguageAttributes);const s=t.matchAll(/<script[^>]*>([\s\S]*?)<\/script>/gi);for(const n of s){const s=n[1],i=t.indexOf(n[0])+n[0].indexOf(s);this.extractMeaningfulStringsWithPosition(s,"javascript").forEach(n=>{const s=this.getPositionInfo(t,n.absoluteStart+i,n.absoluteEnd+i);n.lineNumber=s.lineNumber,n.startPosition=s.startPosition,n.endPosition=s.endPosition,n.columnStart=s.columnStart,n.columnEnd=s.columnEnd,n.absoluteStart+=i,n.absoluteEnd+=i,e.strings.push(n)})}return e}parseHtmlContent(t,e=!1,n=0,s,i="html"){const r={htmlText:[],naturalLanguageAttributes:[]};return t.replace(/<script[\s\S]*?<\/script>/gi,"").replace(/<style[\s\S]*?<\/style>/gi,""),[...t.matchAll(/>([^<]*?)</gs)].forEach(o=>{let a=o[1].trim().replace(/\s+/g," ").replace(/\n/g," ");if(a&&a.length>0&&!this.isNonTextualContent({text:a})){const l=o.index,u=t.substring(0,l+1),c=(u.match(/<script\b[^>]*>/gi)||[]).length,g=(u.match(/<\/script>/gi)||[]).length,h=(u.match(/<style\b[^>]*>/gi)||[]).length,m=(u.match(/<\/style>/gi)||[]).length;if(!(c>g||h>m)){const l=e&&(a.includes("{")||a.includes("}")),u=a.includes("{{")&&a.includes("}}");if(!l&&!u){const e=s||t,l=o.index+n,u=o.index+o[0].length+n,c=this.getPositionInfo(e,l,u),g=o[1],h=g.trim(),m=o.index+1+g.indexOf(h)+n,d=e.substring(0,m).split("\n"),p=d.length,x=d[d.length-1].length,f=h.length,b={lineNumber:p,columnStart:x,columnEnd:x+f,absoluteStart:m,absoluteEnd:m+f};r.htmlText.push({text:a.replace(/\n/,"").trim(),type:"htmlText",context:i,lineNumber:b.lineNumber,startPosition:b.columnStart,endPosition:b.columnEnd,columnStart:b.columnStart,columnEnd:b.columnEnd,absoluteStart:b.absoluteStart,absoluteEnd:b.absoluteEnd,originalStartPosition:c.columnStart,originalEndPosition:c.columnEnd,originalAbsoluteStart:c.absoluteStart,originalAbsoluteEnd:c.absoluteEnd,originalMatch:o[0]})}}}}),["placeholder","title","alt","aria-label","label","value","aria-description","aria-labelledby","data-tooltip","data-title","data-description","data-placeholder","data-label"].forEach(o=>{const a=new RegExp(`\\b${o}\\s*=\\s*["']([^"']+)["']`,"gi");[...t.matchAll(a)].forEach(a=>{const l=a[1].trim(),u=a[0],c=a.index,g=":"===(c>0?t[c-1]:""),h=e&&(l.includes("{")||l.includes("}"));if(!g&&!h&&l&&l.length>0&&!this.isNonTextualContent({text:l,isAttribute:!0})){const e=s||t,c=a.index+n,g=a.index+u.length+n,h=this.getPositionInfo(e,c,g),m=u.indexOf('"')+1,d=u.lastIndexOf('"'),p=a.index+m+n,x=a.index+d+n,f=this.getPositionInfo(e,p,x);r.naturalLanguageAttributes.push({text:l.replace(/\n/,"").trim(),type:"attribute",context:i,attribute:o,lineNumber:f.lineNumber,startPosition:f.columnStart,endPosition:f.columnEnd,columnStart:f.columnStart,columnEnd:f.columnEnd,absoluteStart:f.absoluteStart,absoluteEnd:f.absoluteEnd,originalStartPosition:h.columnStart,originalEndPosition:h.columnEnd,originalAbsoluteStart:h.absoluteStart,originalAbsoluteEnd:h.absoluteEnd,originalMatch:u})}})}),r}getPositionInfo(t,e,n){const s=t.substring(0,e).split("\n"),i=s.length,r=s[s.length-1].length,o=r+(n-e);return{lineNumber:i,startPosition:r,endPosition:o,columnStart:r,columnEnd:o,absoluteStart:e,absoluteEnd:n}}parseDirectory(t){const e=[];try{const n=T.readdirSync(t);for(const s of n){const n=w.join(t,s),i=T.statSync(n);if(i.isDirectory())["node_modules",".git",".next","dist","build",".vscode"].includes(s)||e.push(...this.parseDirectory(n));else if(i.isFile()){const t=this.parseFile(n);t&&e.push(t)}}}catch(e){console.error(`Error reading directory ${t}:`,e.message)}return e.filter(Boolean)}filterMeaningfulText(t){return t.filter(t=>!(!t||"string"!=typeof t||0===t.trim().length||t.trim().length<2||[/^[0-9]+$/,/^[^a-zA-Z]*$/,/^(true|false|null|undefined)$/i,/^(div|span|p|h[1-6]|img|a|li|ul|ol)$/i,/^[\s\n\r\t]+$/].some(e=>e.test(t.trim())))).map(t=>t.trim())}generateSummary(t){const e={totalFiles:t.length,fileTypes:{},totalTexts:0,textTypes:{htmlText:0,naturalLanguageAttributes:0,strings:0},allTexts:[]};return t.forEach(t=>{const n=t.extension;e.fileTypes[n]=(e.fileTypes[n]||0)+1,Object.keys(t.extractedText).forEach(n=>{const s=t.extractedText[n];Array.isArray(s)&&(e.textTypes[n]=(e.textTypes[n]||0)+s.length,e.totalTexts+=s.length,s.forEach(n=>{"object"==typeof n&&n.text&&e.allTexts.push({...n,file:t.fileName,filePath:t.filePath})}))})}),e.allTexts.sort((t,e)=>(t?.lineNumber??0)!==(e?.lineNumber??0)?(t?.lineNumber??0)-(e?.lineNumber??0):(t?.startPosition??0)-(e?.startPosition??0)),e}exportToJson(t,e){const n=this.generateSummary(t),s={metadata:{timestamp:(new Date).toISOString(),totalFiles:t.length,supportedExtensions:this.supportedExtensions},summary:n,detailedResults:t};try{const t=w.dirname(e);T.existsSync(t)||(T.mkdirSync(t,{recursive:!0}),console.log(`Created directory: ${t}`)),T.writeFileSync(e,JSON.stringify(s,null,2),"utf8"),console.log(`Results exported to: ${e}`)}catch(t){console.error(`Error writing to file: ${t.message}`)}}exportToText(t,e){const n=this.generateSummary(t);let s="Document Parser Results\n";s+="======================\n\n",s+=`Total Files Processed: ${n.totalFiles}\n`,s+=`Total Meaningful Texts Found: ${n.totalTexts}\n\n`,s+="File Types:\n",Object.keys(n.fileTypes).forEach(t=>{s+=`  ${t}: ${n.fileTypes[t]} files\n`}),s+="\nText Types:\n",Object.keys(n.textTypes).forEach(t=>{s+=`  ${t}: ${n.textTypes[t]} items\n`}),s+="\n\nAll Meaningful Texts with Position Info:\n",s+="========================================\n\n",n.allTexts.forEach((t,e)=>{let n=`${e+1}. [${t.type}] ${t.file}`;t.lineNumber&&(n+=` (Line: ${t.lineNumber}, Pos: ${t.startPosition}-${t.endPosition})`),t.attribute&&(n+=` [${t.attribute}]`),n+=`: "${t.text}"`,t.originalMatch&&t.originalMatch!==t.text&&(n+=` | Original: ${t.originalMatch}`),s+=n+"\n"});try{const t=w.dirname(e);T.existsSync(t)||(T.mkdirSync(t,{recursive:!0}),console.log(`Created directory: ${t}`)),T.writeFileSync(e,s,"utf8"),console.log(`Text results exported to: ${e}`)}catch(t){console.error(`Error writing to file: ${t.message}`)}}}export{O as DocumentParser,O as default};